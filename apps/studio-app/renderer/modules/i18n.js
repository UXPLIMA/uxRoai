import { state } from "./state.js";
import { DEFAULT_LANGUAGE, DEFAULT_PROVIDER } from "./constants.js";

const I18N = {
  en: {
    logoSub: "Roblox Build + Test",
    projectsHeader: "Projects",
    settings: "Settings",
    agentLabel: "Agent",
    startAgent: "Start Agent",
    stopAgent: "Stop Agent",
    managedUnknown: "Managed: unknown",
    managedRunning: "running",
    managedStopped: "stopped",
    managedPrefix: "Managed",
    startedAt: "started",
    runtimeError: "error",
    agentUrlLabel: "Agent URL",
    claudeProviderLabel: "AI Provider",
    claudeCodeCommandLabel: "Claude Code Command",
    claudeCodeArgsLabel: "Claude Code Args",
    apiKeyLabel: "Claude API Key",
    modelLabel: "Model",
    codexCommandLabel: "Codex Command",
    openaiApiKeyLabel: "OpenAI API Key",
    languageLabel: "Language",
    maxRetriesLabel: "Max Retries",
    minPlaytestSecondsLabel: "Min Playtest Duration (s)",
    planTimeoutLabel: "Plan Timeout (s)",
    claudeCodeTimeoutLabel: "CLI Timeout (s)",
    codexTimeoutLabel: "CLI Timeout (s)",
    geminiTimeoutLabel: "CLI Timeout (s)",
    customInstructionsLabel: "Custom AI Instructions",
    resetToDefaults: "Reset to Defaults",
    saveSettings: "Save Settings",
    agentLogs: "Agent logs",
    taskFlow: "TASK FLOW",
    refresh: "Refresh",
    promptPlaceholder: "Describe a feature or task... (use /ask for questions)",
    sendQueue: "Send",
    noChanges: "No recorded changes yet.",
    noSummary: "No summary yet.",
    noPlaytest: "No playtest result.",
    waitingStudio: "Waiting for Studio plugin...",
    createdAt: "created",
    worker: "worker",
    targets: "target(s)",
    taskSendFailed: "Task send failed",
    settingsSaveFailed: "Agent settings save failed",
    agentStartFailed: "Agent start failed",
    agentStopFailed: "Agent stop failed",
    projectPrompt: "Project name",
    projectCreateFailed: "Project create failed",
    projectModalTitle: "Create Project",
    projectNameLabel: "Project Name",
    projectNamePlaceholder: "My project",
    cancel: "Cancel",
    create: "Create",
    statusSuccess: "ok",
    statusIssue: "issue",
    changesCount: "changes",
    playtestUnavailable: "No playtest details yet.",
    playtestSummaryOk: "Playtest passed.",
    playtestSummaryFailed: "Playtest failed.",
    changeApplied: "Applied",
    changedScript: "script",
    changeOpenLabel: "Details",
    copiedFromPath: "path",
    online: "online",
    offline: "offline",
    diffNoText: "(no text diff)",
    diffTruncated: "... diff truncated ...",
    provider_code: "Claude Code (subscription)",
    provider_api: "Claude API Key",
    provider_codex: "Codex CLI",
    provider_openai_api: "OpenAI API Key",
    provider_gemini: "Gemini CLI",
    provider_gemini_api: "Gemini API Key",
    geminiCommandLabel: "Gemini Command",
    geminiApiKeyLabel: "Gemini API Key",
    model_gemini_3_pro: "Gemini 3 Pro",
    model_gemini_3_flash: "Gemini 3 Flash",
    model_gemini_25_pro: "Gemini 2.5 Pro",
    model_gemini_25_flash: "Gemini 2.5 Flash",
    model_gemini_25_flash_lite: "Gemini 2.5 Flash Lite",
    apiKeyOptional: "Not required when provider is Claude Code",
    codeCommandPlaceholder: "claude",
    codeArgsPlaceholder: "-p",
    model_opus_46: "Claude Opus 4.6 (`claude-opus-4-6`)",
    model_sonnet_45_dated: "Claude Sonnet 4.5 (dated, `claude-sonnet-4-5-20250929`)",
    model_sonnet_45: "Claude Sonnet 4.5 (alias, `claude-sonnet-4-5`)",
    model_haiku_45_dated: "Claude Haiku 4.5 (dated, `claude-haiku-4-5-20251001`)",
    model_haiku_45: "Claude Haiku 4.5 (alias, `claude-haiku-4-5`)",
    model_gpt53_codex: "GPT-5.3 Codex",
    model_gpt52_codex: "GPT-5.2 Codex",
    model_gpt51_codex: "GPT-5.1 Codex",
    model_gpt51_codex_max: "GPT-5.1 Codex Max",
    model_gpt51_codex_mini: "GPT-5.1 Codex Mini",
    model_gpt5_codex: "GPT-5 Codex",
    model_gpt52: "GPT-5.2",
    model_gpt51: "GPT-5.1",
    model_gpt5: "GPT-5",
    model_gpt5_mini: "GPT-5 Mini",
    model_gpt41: "GPT-4.1",
    lang_english: "English",
    lang_turkish: "Turkce",
    processing: "Processing...",
    thinking: "Thinking...",
    rawLogs: "Raw logs",
    copied: "Copied!",
    playtest: "PLAYTEST",
    playtestRunning: "Running playtest...",
    applied: "Applied",
    stopTask: "Stop",
    taskStopped: "Stopped by user",
    stopTaskFailed: "Stop failed",
    createFolder: "Create Folder",
    folderName: "Folder Name",
    folderNamePlaceholder: "My folder",
    folderCreateFailed: "Folder create failed",
    deleteFolder: "Delete",
    noFolder: "Ungrouped",
    attachFile: "Attach file",
    removeImage: "Remove",
    deleteChat: "Delete",
    renameChat: "Rename",
    renameChatPrompt: "New message text:",
    emptyState: "Select or create a chat to get started",
    emptyStateChat: "Send a message to start building",
    agentOfflineError: "Agent is not running. Start it from Settings or run it manually.",
    planPreviewTitle: "Plan Preview",
    planApprove: "Approve & Execute",
    planReject: "Cancel",
    planWaiting: "Waiting for approval...",
    planApproved: "Plan approved",
    planRejected: "Plan rejected",
    planActions: "actions",
    planRemoveAction: "Remove",
    retryWithFix: "Retry with Fix",
    undoLastPlan: "Undo",
    branchFromHere: "Branch",
    branchCreated: "Branch created",
    tokensUsed: "tokens",
    transparencyLabel: "Window Transparency",
    revertChange: "Revert",
    revertConfirm: "Revert this change?",
    revertSuccess: "Revert command sent",
    queuedCount: "queued",
    newChat: "New Chat",
    chatsHeader: "Chats",
    editMessage: "Edit",
    rewindConfirm: "Rewind conversation to this message? Messages after this point will be removed.",
    rewindTitle: "Rewind Conversation",
    rewindBtn: "Rewind",
    clearHistory: "Clear History",
    duplicateProject: "Duplicate",
    copyPrompt: "Copy Prompt",
    copyResponse: "Copy Response",
    rerunTask: "Re-run",
    setupWelcomeTitle: "Welcome to uxRoai Studio",
    setupWelcomeDesc: "Let's get you set up in a few steps.",
    setupCliTitle: "AI Provider",
    setupCliDesc: "Select your AI provider and configure it.",
    setupPluginTitle: "Studio Plugin",
    setupPluginDesc: "Make sure the uxRoai plugin is installed in Roblox Studio.",
    setupReadyTitle: "You're All Set!",
    setupReadyDesc: "Start building by sending a message.",
    setupNext: "Next",
    setupBack: "Back",
    setupFinish: "Get Started",
    setupSkip: "Skip Setup",
    writingScript: "Writing script...",
    searchingInstances: "Searching...",
    creatingInstance: "Creating...",
    deletingInstance: "Deleting...",
    settingProperty: "Setting property...",
    executingAction: "Executing...",
    runningPlaytest: "Running playtest...",
    welcomeOverlayTitle: "Welcome to uxRoai Studio",
    welcomeOverlayDesc: "Your AI-powered Roblox development companion",
    welcomeOverlayDismiss: "Get Started",
    projectSettingsLabel: "Project-Specific Settings",
    projectApiKeyLabel: "Project API Key Override",
    projectCustomPromptLabel: "Project Custom Prompt",
    saveProjectSettings: "Save Project Settings",
    projectSettingsSaved: "Project settings saved",
    connErrorTitle: "Connection Lost",
    connErrorDesc: "Unable to reach the agent. Retrying automatically...",
    connErrorRetry: "Retry Now",
    connErrorDismiss: "Dismiss",
    connErrorCountdown: "Retrying in {s}s...",
    connErrorReconnected: "Reconnected!",
  },
  tr: {
    logoSub: "Roblox Gelistir + Test Et",
    projectsHeader: "Projeler",
    settings: "Ayarlar",
    agentLabel: "Agent",
    startAgent: "Agent Baslat",
    stopAgent: "Agent Durdur",
    managedUnknown: "Yonettigin Agent: bilinmiyor",
    managedRunning: "calisiyor",
    managedStopped: "durdu",
    managedPrefix: "Yonettigin Agent",
    startedAt: "baslangic",
    runtimeError: "hata",
    agentUrlLabel: "Agent URL",
    claudeProviderLabel: "AI Saglayici",
    claudeCodeCommandLabel: "Claude Code Komutu",
    claudeCodeArgsLabel: "Claude Code Argumanlari",
    apiKeyLabel: "Claude API Key",
    modelLabel: "Model",
    codexCommandLabel: "Codex Komutu",
    openaiApiKeyLabel: "OpenAI API Key",
    languageLabel: "Dil",
    maxRetriesLabel: "Maks Deneme Sayisi",
    minPlaytestSecondsLabel: "Min Playtest Suresi (sn)",
    planTimeoutLabel: "Plan Zaman Asimi (sn)",
    claudeCodeTimeoutLabel: "CLI Zaman Asimi (sn)",
    codexTimeoutLabel: "CLI Zaman Asimi (sn)",
    geminiTimeoutLabel: "CLI Zaman Asimi (sn)",
    customInstructionsLabel: "Ozel AI Talimatlari",
    resetToDefaults: "Varsayilana Sifirla",
    saveSettings: "Ayarlari Kaydet",
    agentLogs: "Agent loglari",
    taskFlow: "GOREV AKISI",
    refresh: "Yenile",
    promptPlaceholder: "Bir ozellik veya gorev tanimla... (soru icin /ask kullan)",
    sendQueue: "Gonder",
    noChanges: "Kayitli degisiklik yok.",
    noSummary: "Henuz ozet yok.",
    noPlaytest: "Playtest sonucu yok.",
    waitingStudio: "Studio plugin bekleniyor...",
    createdAt: "olusturuldu",
    worker: "worker",
    targets: "hedef",
    taskSendFailed: "Gorev gonderme basarisiz",
    settingsSaveFailed: "Agent ayarlari kaydedilemedi",
    agentStartFailed: "Agent baslatilamadi",
    agentStopFailed: "Agent durdurulamadi",
    projectPrompt: "Proje adi",
    projectCreateFailed: "Proje olusturulamadi",
    projectModalTitle: "Proje Olustur",
    projectNameLabel: "Proje Adi",
    projectNamePlaceholder: "Projem",
    cancel: "Iptal",
    create: "Olustur",
    statusSuccess: "ok",
    statusIssue: "sorun",
    changesCount: "degisiklik",
    playtestUnavailable: "Henuz playtest detayi yok.",
    playtestSummaryOk: "Playtest basarili.",
    playtestSummaryFailed: "Playtest basarisiz.",
    changeApplied: "Uygulandi",
    changedScript: "script",
    changeOpenLabel: "Detay",
    copiedFromPath: "yol",
    online: "online",
    offline: "offline",
    diffNoText: "(metin diff yok)",
    diffTruncated: "... diff kisaltildi ...",
    provider_code: "Claude Code (abonelik)",
    provider_api: "Claude API Key",
    provider_codex: "Codex CLI",
    provider_openai_api: "OpenAI API Key",
    provider_gemini: "Gemini CLI",
    provider_gemini_api: "Gemini API Key",
    geminiCommandLabel: "Gemini Komutu",
    geminiApiKeyLabel: "Gemini API Key",
    model_gemini_3_pro: "Gemini 3 Pro",
    model_gemini_3_flash: "Gemini 3 Flash",
    model_gemini_25_pro: "Gemini 2.5 Pro",
    model_gemini_25_flash: "Gemini 2.5 Flash",
    model_gemini_25_flash_lite: "Gemini 2.5 Flash Lite",
    apiKeyOptional: "Provider Claude Code iken gerekli degil",
    codeCommandPlaceholder: "claude",
    codeArgsPlaceholder: "-p",
    model_opus_46: "Claude Opus 4.6 (`claude-opus-4-6`)",
    model_sonnet_45_dated: "Claude Sonnet 4.5 (tarihli, `claude-sonnet-4-5-20250929`)",
    model_sonnet_45: "Claude Sonnet 4.5 (alias, `claude-sonnet-4-5`)",
    model_haiku_45_dated: "Claude Haiku 4.5 (tarihli, `claude-haiku-4-5-20251001`)",
    model_haiku_45: "Claude Haiku 4.5 (alias, `claude-haiku-4-5`)",
    model_gpt53_codex: "GPT-5.3 Codex",
    model_gpt52_codex: "GPT-5.2 Codex",
    model_gpt51_codex: "GPT-5.1 Codex",
    model_gpt51_codex_max: "GPT-5.1 Codex Max",
    model_gpt51_codex_mini: "GPT-5.1 Codex Mini",
    model_gpt5_codex: "GPT-5 Codex",
    model_gpt52: "GPT-5.2",
    model_gpt51: "GPT-5.1",
    model_gpt5: "GPT-5",
    model_gpt5_mini: "GPT-5 Mini",
    model_gpt41: "GPT-4.1",
    lang_english: "English",
    lang_turkish: "Turkce",
    processing: "Isleniyor...",
    thinking: "Dusunuyor...",
    rawLogs: "Ham loglar",
    copied: "Kopyalandi!",
    playtest: "PLAYTEST",
    playtestRunning: "Playtest calisiyor...",
    applied: "Uygulandi",
    stopTask: "Durdur",
    taskStopped: "Kullanici tarafindan durduruldu",
    stopTaskFailed: "Durdurma basarisiz",
    createFolder: "Klasor Olustur",
    folderName: "Klasor Adi",
    folderNamePlaceholder: "Klasorum",
    folderCreateFailed: "Klasor olusturulamadi",
    deleteFolder: "Sil",
    noFolder: "Gruplanmamis",
    attachFile: "Dosya ekle",
    removeImage: "Kaldir",
    deleteChat: "Sil",
    renameChat: "Yeniden adlandir",
    renameChatPrompt: "Yeni mesaj metni:",
    emptyState: "Baslamak icin bir sohbet secin veya olusturun",
    emptyStateChat: "Olusturmaya baslamak icin bir mesaj gonderin",
    agentOfflineError: "Agent calismıyor. Ayarlar'dan baslatin veya manuel calistirin.",
    planPreviewTitle: "Plan Onizleme",
    planApprove: "Onayla ve Calistir",
    planReject: "Iptal",
    planWaiting: "Onay bekleniyor...",
    planApproved: "Plan onaylandi",
    planRejected: "Plan reddedildi",
    planActions: "eylem",
    planRemoveAction: "Kaldir",
    retryWithFix: "Hatayı Duzelt",
    undoLastPlan: "Geri Al",
    branchFromHere: "Dallandir",
    branchCreated: "Dal olusturuldu",
    tokensUsed: "token",
    transparencyLabel: "Pencere Seffafligi",
    revertChange: "Geri Al",
    revertConfirm: "Bu degisikligi geri al?",
    revertSuccess: "Geri alma komutu gonderildi",
    queuedCount: "kuyrukta",
    newChat: "Yeni Sohbet",
    chatsHeader: "Sohbetler",
    editMessage: "Duzenle",
    rewindConfirm: "Konusmayi bu mesaja geri sar? Sonraki mesajlar silinecek.",
    rewindTitle: "Konusmayi Geri Sar",
    rewindBtn: "Geri Sar",
    clearHistory: "Gecmisi Temizle",
    duplicateProject: "Kopyala",
    copyPrompt: "Prompt Kopyala",
    copyResponse: "Yaniti Kopyala",
    rerunTask: "Tekrar Calistir",
    setupWelcomeTitle: "uxRoai Studio'ya Hosgeldin",
    setupWelcomeDesc: "Birkaç adimda ayarlarimizi yapalim.",
    setupCliTitle: "AI Saglayici",
    setupCliDesc: "AI saglayicinizi secin ve yapilandirin.",
    setupPluginTitle: "Studio Plugin",
    setupPluginDesc: "uxRoai plugininin Roblox Studio'da kurulu oldugundan emin olun.",
    setupReadyTitle: "Hazirsiniz!",
    setupReadyDesc: "Bir mesaj gondererek olusturmaya baslayin.",
    setupNext: "Ileri",
    setupBack: "Geri",
    setupFinish: "Basla",
    setupSkip: "Kurulumu Atla",
    writingScript: "Script yaziliyor...",
    searchingInstances: "Araniyor...",
    creatingInstance: "Olusturuluyor...",
    deletingInstance: "Siliniyor...",
    settingProperty: "Ozellik ayarlaniyor...",
    executingAction: "Calistiriliyor...",
    runningPlaytest: "Playtest calisiyor...",
    welcomeOverlayTitle: "uxRoai Studio'ya Hosgeldin",
    welcomeOverlayDesc: "AI destekli Roblox gelistirme arkadasin",
    welcomeOverlayDismiss: "Basla",
    projectSettingsLabel: "Projeye Ozel Ayarlar",
    projectApiKeyLabel: "Proje API Key (Override)",
    projectCustomPromptLabel: "Proje Ozel Prompt",
    saveProjectSettings: "Proje Ayarlarini Kaydet",
    projectSettingsSaved: "Proje ayarlari kaydedildi",
    connErrorTitle: "Baglanti Kesildi",
    connErrorDesc: "Agent'a ulasilamiyor. Otomatik yeniden deneniyor...",
    connErrorRetry: "Simdi Dene",
    connErrorDismiss: "Kapat",
    connErrorCountdown: "{s} saniye icinde yeniden denenecek...",
    connErrorReconnected: "Yeniden baglandi!",
  },
};

export function normalizeLanguage(value) {
  const text = String(value || "").trim().toLowerCase();
  if (text === "tr") return "tr";
  return DEFAULT_LANGUAGE;
}

export function t(key) {
  const lang = state.language || DEFAULT_LANGUAGE;
  const pack = I18N[lang] || I18N.en;
  return pack[key] || I18N.en[key] || key;
}

const MODEL_SHORT_LABELS = {
  "claude-opus-4-6": "Opus 4.6",
  "claude-sonnet-4-5-20250929": "Sonnet 4.5",
  "claude-sonnet-4-5": "Sonnet 4.5",
  "claude-haiku-4-5-20251001": "Haiku 4.5",
  "claude-haiku-4-5": "Haiku 4.5",
  "gpt-5.3-codex": "GPT-5.3 Codex",
  "gpt-5.2-codex": "GPT-5.2 Codex",
  "gpt-5.1-codex": "GPT-5.1 Codex",
  "gpt-5.1-codex-max": "GPT-5.1 Max",
  "gpt-5.1-codex-mini": "GPT-5.1 Mini",
  "gpt-5-codex": "GPT-5 Codex",
  "gpt-5.2": "GPT-5.2",
  "gpt-5.1": "GPT-5.1",
  "gpt-5": "GPT-5",
  "gpt-5-mini": "GPT-5 Mini",
  "gpt-4.1": "GPT-4.1",
  "gemini-3-pro-preview": "Gemini 3 Pro",
  "gemini-3-flash-preview": "Gemini 3 Flash",
  "gemini-2.5-pro": "Gemini 2.5 Pro",
  "gemini-2.5-flash": "Gemini 2.5 Flash",
  "gemini-2.5-flash-lite": "Gemini 2.5 Lite",
};

export function modelLabel(model, short = false) {
  if (short) return MODEL_SHORT_LABELS[model] || model;
  const keyMap = {
    "claude-opus-4-6": "model_opus_46",
    "claude-sonnet-4-5-20250929": "model_sonnet_45_dated",
    "claude-sonnet-4-5": "model_sonnet_45",
    "claude-haiku-4-5-20251001": "model_haiku_45_dated",
    "claude-haiku-4-5": "model_haiku_45",
    "gpt-5.3-codex": "model_gpt53_codex",
    "gpt-5.2-codex": "model_gpt52_codex",
    "gpt-5.1-codex": "model_gpt51_codex",
    "gpt-5.1-codex-max": "model_gpt51_codex_max",
    "gpt-5.1-codex-mini": "model_gpt51_codex_mini",
    "gpt-5-codex": "model_gpt5_codex",
    "gpt-5.2": "model_gpt52",
    "gpt-5.1": "model_gpt51",
    "gpt-5": "model_gpt5",
    "gpt-5-mini": "model_gpt5_mini",
    "gpt-4.1": "model_gpt41",
    "gemini-3-pro-preview": "model_gemini_3_pro",
    "gemini-3-flash-preview": "model_gemini_3_flash",
    "gemini-2.5-pro": "model_gemini_25_pro",
    "gemini-2.5-flash": "model_gemini_25_flash",
    "gemini-2.5-flash-lite": "model_gemini_25_flash_lite",
  };
  const i18nKey = keyMap[model];
  return i18nKey ? t(i18nKey) : model;
}

export function normalizeProvider(value) {
  const text = String(value || "").trim().toLowerCase();
  if (["api", "codex", "openai-api", "gemini", "gemini-api"].includes(text)) return text;
  return DEFAULT_PROVIDER;
}

export function displayStatus(status) {
  const normalized = status || "pending";
  const map = {
    pending: { en: "pending", tr: "bekliyor" },
    running: { en: "running", tr: "calisiyor" },
    done: { en: "done", tr: "tamam" },
    failed: { en: "failed", tr: "basarisiz" },
    stopped: { en: "stopped", tr: "durduruldu" },
    bad: { en: "failed", tr: "basarisiz" },
    good: { en: "good", tr: "iyi" },
  };
  const entry = map[normalized];
  if (!entry) return normalized;
  return state.language === "tr" ? entry.tr : entry.en;
}
