<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>uxRoai Studio</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="app-shell" id="appShell">
      <div class="titlebar" id="titlebar">
        <div class="titlebar-drag">
          <img class="titlebar-logo" src="./logo.png" alt="" />
          <span class="titlebar-title">uxRoai Studio</span>
        </div>
        <div class="titlebar-controls">
          <button id="titlebarMinBtn" class="titlebar-btn" title="Minimize">&#x2014;</button>
          <button id="titlebarMaxBtn" class="titlebar-btn" title="Maximize">&#x25A1;</button>
          <button id="titlebarCloseBtn" class="titlebar-btn titlebar-close" title="Close">&#x2715;</button>
        </div>
      </div>
      <aside class="sidebar" id="sidebar">
        <div class="logo">
          <img class="logo-img" src="./logo.png" alt="uxRoai" />
          <div class="logo-text">
            <div class="logo-title">uxRoai Studio</div>
            <div id="logoSubText" class="logo-sub">Roblox Build + Test</div>
          </div>
          <button id="sidebarToggleBtn" class="icon-btn sidebar-toggle-btn" title="Toggle sidebar">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
          </button>
        </div>

        <div class="section">
          <div class="section-head">
            <span id="projectsHeaderText">Projects</span>
            <div class="section-head-actions">
              <button id="createFolderBtn" class="icon-btn" title="New folder">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
              </button>
              <button id="createProjectBtn" class="icon-btn" title="New chat">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/><line x1="12" y1="8" x2="12" y2="14"/><line x1="9" y1="11" x2="15" y2="11"/></svg>
              </button>
            </div>
          </div>
          <div id="projectList" class="project-list"></div>
        </div>

        <div class="section chat-section" id="chatSection" style="display:none">
          <div class="section-head">
            <span id="chatsHeaderText">Chats</span>
            <div class="section-head-actions">
              <button id="createChatBtn" class="icon-btn" title="New chat">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </button>
            </div>
          </div>
          <div id="chatList" class="chat-list"></div>
        </div>

        <div class="sidebar-footer">
          <div class="health-row">
            <span id="agentLabelText" class="label">Agent</span>
            <span id="agentHealth" class="pill bad">offline</span>
          </div>
          <div class="agent-controls">
            <button id="startAgentBtn" class="secondary-btn">Start Agent</button>
            <button id="stopAgentBtn" class="secondary-btn">Stop Agent</button>
          </div>
          <div id="agentRuntimeText" class="agent-runtime">Managed: unknown</div>
          <button id="settingsBtn" class="secondary-btn settings-btn">Settings</button>
        </div>
      </aside>

      <main class="main-area">
        <header class="topbar">
          <div>
            <div id="taskFlowText" class="kicker">TASK FLOW</div>
            <h1 id="projectTitle">Default</h1>
          </div>
          <div class="top-actions">
          </div>
        </header>

        <section id="timeline" class="timeline"></section>

        <section class="composer" id="composerSection">
          <div id="queueIndicator" class="queue-indicator" style="display:none"></div>
          <div class="composer-top-bar">
            <select id="composerModelSelect" class="composer-model-select" title="Model"></select>
            <label class="auto-playtest-toggle" title="Auto-run playtest after task completion">
              <input type="checkbox" id="autoPlaytestToggle" />
              <span class="auto-playtest-slider"></span>
              <span class="auto-playtest-label">Auto-test</span>
            </label>
          </div>
          <div id="imagePreviewBar" class="image-preview-bar"></div>
          <div class="composer-row">
            <button id="attachImageBtn" class="composer-icon-btn" title="Attach file">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
            </button>
            <textarea id="promptInput" rows="1" placeholder="Message..."></textarea>
            <button id="sendPromptBtn" class="composer-icon-btn send-btn" title="Send">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
            </button>
          </div>
        </section>
      </main>
    </div>

    <div id="projectModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="projectModalTitleText">
      <div class="modal">
        <div class="modal-head">
          <h2 id="projectModalTitleText">Create Project</h2>
          <button id="projectModalCloseBtn" class="icon-btn" aria-label="Close">x</button>
        </div>
        <label id="projectNameLabelText" class="input-label" for="projectNameInput">Project Name</label>
        <input id="projectNameInput" class="text-input" placeholder="My project" />
        <div class="modal-actions">
          <button id="projectCancelBtn" class="secondary-btn">Cancel</button>
          <button id="projectCreateConfirmBtn" class="primary-btn">Create</button>
        </div>
      </div>
    </div>

    <div id="settingsModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitleText">
      <div class="modal settings-modal">
        <div class="modal-head">
          <h2 id="settingsTitleText">Settings</h2>
          <button id="settingsCloseBtn" class="icon-btn" aria-label="Close">x</button>
        </div>
        <label id="agentUrlLabelText" class="input-label" for="agentUrlInput">Agent URL</label>
        <input id="agentUrlInput" class="text-input" placeholder="http://127.0.0.1:41117" />
        <label id="claudeProviderLabelText" class="input-label" for="claudeProviderInput">AI Provider</label>
        <select id="claudeProviderInput" class="text-input">
          <option value="code" selected>Claude Code</option>
          <option value="codex">Codex CLI</option>
          <option value="gemini">Gemini CLI</option>
        </select>
        <div id="claudeFieldsGroup">
          <label id="claudeCodeCommandLabelText" class="input-label" for="claudeCodeCommandInput">Claude Code Command</label>
          <input id="claudeCodeCommandInput" class="text-input" placeholder="claude" />
          <label id="claudeCodeArgsLabelText" class="input-label" for="claudeCodeArgsInput">Claude Code Args</label>
          <input id="claudeCodeArgsInput" class="text-input" placeholder="-p" />
          <label id="claudeCodeTimeoutLabelText" class="input-label" for="claudeCodeTimeoutInput">CLI Timeout (s)</label>
          <input id="claudeCodeTimeoutInput" class="text-input" type="number" min="5" max="600" value="90" />
        </div>
        <div id="codexFieldsGroup" style="display:none">
          <label id="codexCommandLabelText" class="input-label" for="codexCommandInput">Codex Command</label>
          <input id="codexCommandInput" class="text-input" placeholder="codex" />
          <label id="codexTimeoutLabelText" class="input-label" for="codexTimeoutInput">CLI Timeout (s)</label>
          <input id="codexTimeoutInput" class="text-input" type="number" min="5" max="600" value="180" />
        </div>
        <div id="geminiFieldsGroup" style="display:none">
          <label id="geminiCommandLabelText" class="input-label" for="geminiCommandInput">Gemini Command</label>
          <input id="geminiCommandInput" class="text-input" placeholder="gemini" />
          <label id="geminiTimeoutLabelText" class="input-label" for="geminiTimeoutInput">CLI Timeout (s)</label>
          <input id="geminiTimeoutInput" class="text-input" type="number" min="5" max="600" value="300" />
        </div>
        <label id="claudeModelLabelText" class="input-label" for="claudeModelInput">Model</label>
        <select id="claudeModelInput" class="text-input">
          <option value="claude-opus-4-6">Claude Opus 4.6 (`claude-opus-4-6`)</option>
          <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (dated, `claude-sonnet-4-5-20250929`)</option>
          <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5 (alias, `claude-sonnet-4-5`)</option>
          <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (dated, `claude-haiku-4-5-20251001`)</option>
          <option value="claude-haiku-4-5">Claude Haiku 4.5 (alias, `claude-haiku-4-5`)</option>
        </select>
        <label id="languageLabelText" class="input-label" for="languageInput">Language</label>
        <select id="languageInput" class="text-input">
          <option value="en">English</option>
          <option value="tr">Turkce</option>
        </select>
        <label id="maxRetriesLabelText" class="input-label" for="maxRetriesInput">Max Retries</label>
        <input id="maxRetriesInput" class="text-input" type="number" min="1" max="20" value="10" />
        <label id="minPlaytestSecondsLabelText" class="input-label" for="minPlaytestSecondsInput">Min Playtest Duration (s)</label>
        <input id="minPlaytestSecondsInput" class="text-input" type="number" min="0" max="120" value="10" />
        <label id="planTimeoutLabelText" class="input-label" for="planTimeoutInput">Plan Timeout (s)</label>
        <input id="planTimeoutInput" class="text-input" type="number" min="30" max="1200" value="600" />
        <div class="toggle-row">
          <label id="transparencyLabelText" class="input-label">Window Transparency</label>
          <label class="toggle-switch">
            <input type="checkbox" id="transparencyToggle" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <label id="customInstructionsLabelText" class="input-label" for="customInstructionsInput">Custom AI Instructions</label>
        <textarea id="customInstructionsInput" class="text-input custom-instructions-textarea" rows="8"></textarea>
        <button id="resetCustomInstructionsBtn" class="reset-btn" type="button">Reset to Defaults</button>
        <details class="project-settings-details">
          <summary id="projectSettingsSummary">
            <span id="projectSettingsLabelText">Project-Specific Settings</span>
          </summary>
          <div class="project-settings-content">
            <label id="projectApiKeyLabelText" class="input-label" for="projectApiKeyInput">Project API Key Override</label>
            <input id="projectApiKeyInput" type="password" class="text-input" placeholder="Leave empty to use global key" />
            <label id="projectCustomPromptLabelText" class="input-label" for="projectCustomPromptInput">Project Custom Prompt</label>
            <textarea id="projectCustomPromptInput" class="text-input custom-instructions-textarea" rows="4" placeholder="Additional instructions for this project only..."></textarea>
            <button id="saveProjectSettingsBtn" class="secondary-btn">Save Project Settings</button>
          </div>
        </details>
        <button id="saveAgentBtn" class="secondary-btn">Save Settings</button>
        <details class="agent-log-details" id="logPanelDetails">
          <summary id="agentLogsSummaryText">
            <span>Diagnostic Logs</span>
            <button id="copyAgentLogsBtn" class="copy-btn-inline" title="Copy all logs">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            </button>
            <button id="refreshDiagLogsBtn" class="copy-btn-inline" title="Refresh logs">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
            </button>
          </summary>
          <div class="log-panel">
            <div class="log-diagnostics-bar" id="logDiagBar"></div>
            <div class="log-tabs">
              <button class="log-tab active" data-log-tab="all">All</button>
              <button class="log-tab" data-log-tab="agent">Agent</button>
              <button class="log-tab" data-log-tab="provider">Provider</button>
              <button class="log-tab" data-log-tab="request">Request</button>
              <button class="log-tab" data-log-tab="playtest">Playtest</button>
              <button class="log-tab" data-log-tab="config">Config</button>
            </div>
            <pre id="agentLogBox" class="agent-log-box"></pre>
          </div>
        </details>
      </div>
    </div>

    <template id="taskCardTemplate">
      <div class="chat-conversation" data-task-id="">
        <!-- User bubble (right) -->
        <div class="chat-msg chat-user">
          <div class="chat-bubble chat-bubble-user">
            <div class="chat-prompt"></div>
            <div class="chat-time"></div>
          </div>
        </div>
        <!-- AI response (left) -->
        <div class="chat-msg chat-ai">
          <div class="chat-ai-content">
            <div class="chat-status-line"></div>
            <div class="chat-summary"></div>
            <div class="chat-changes" data-scroll-key="changes-scroll"></div>
            <div class="chat-playtest-panel"></div>
            <details class="chat-raw" data-ui-key="raw-open">
              <summary class="chat-raw-header">
                <span class="chat-raw-label">Raw logs</span>
                <button class="copy-btn" data-copy-target="raw" title="Copy">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                </button>
              </summary>
              <pre class="chat-raw-content" data-scroll-key="raw-scroll"></pre>
            </details>
          </div>
        </div>
      </div>
    </template>

    <div id="folderModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="folderModalTitleText">
      <div class="modal">
        <div class="modal-head">
          <h2 id="folderModalTitleText">Create Folder</h2>
          <button id="folderModalCloseBtn" class="icon-btn" aria-label="Close">x</button>
        </div>
        <label id="folderNameLabelText" class="input-label" for="folderNameInput">Folder Name</label>
        <input id="folderNameInput" class="text-input" placeholder="My folder" />
        <div class="modal-actions">
          <button id="folderCancelBtn" class="secondary-btn">Cancel</button>
          <button id="folderCreateConfirmBtn" class="primary-btn">Create</button>
        </div>
      </div>
    </div>

    <div id="promptModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="promptModalTitleText">
      <div class="modal">
        <div class="modal-head">
          <h2 id="promptModalTitleText">Rename</h2>
          <button id="promptModalCloseBtn" class="icon-btn" aria-label="Close">x</button>
        </div>
        <input id="promptModalInput" class="text-input" placeholder="" />
        <div class="modal-actions">
          <button id="promptModalCancelBtn" class="secondary-btn">Cancel</button>
          <button id="promptModalConfirmBtn" class="primary-btn">OK</button>
        </div>
      </div>
    </div>

    <div id="setupWizard" class="setup-wizard hidden">
      <div class="setup-card">
        <div class="setup-steps">
          <div class="setup-step active" data-step="0"></div>
          <div class="setup-step" data-step="1"></div>
          <div class="setup-step" data-step="2"></div>
          <div class="setup-step" data-step="3"></div>
        </div>

        <div class="setup-screen" id="setupScreen0">
          <div class="setup-icon">
            <img src="./logo.png" alt="uxRoai" class="setup-logo" />
          </div>
          <h2 id="setupWelcomeTitleText">Welcome to uxRoai Studio</h2>
          <p id="setupWelcomeDescText">Let's get you set up in a few steps.</p>
        </div>

        <div class="setup-screen hidden" id="setupScreen1">
          <h2 id="setupCliTitleText">AI Provider</h2>
          <p id="setupCliDescText">Select your AI provider and configure it.</p>
          <select id="setupProviderSelect" class="text-input">
            <option value="code">Claude Code</option>
            <option value="codex">Codex CLI</option>
            <option value="gemini">Gemini CLI</option>
          </select>
        </div>

        <div class="setup-screen hidden" id="setupScreen2">
          <h2 id="setupPluginTitleText">Studio Plugin</h2>
          <p id="setupPluginDescText">Make sure the uxRoai plugin is installed in Roblox Studio.</p>
          <div class="setup-checklist">
            <div class="setup-check-item">1. Copy uxRoai.plugin.lua to Roblox Plugins folder</div>
            <div class="setup-check-item">2. Restart Roblox Studio</div>
            <div class="setup-check-item">3. The plugin will connect automatically</div>
          </div>
        </div>

        <div class="setup-screen hidden" id="setupScreen3">
          <div class="setup-icon">&#x2705;</div>
          <h2 id="setupReadyTitleText">You're All Set!</h2>
          <p id="setupReadyDescText">Start building by sending a message.</p>
        </div>

        <div class="setup-buttons">
          <button id="setupSkipBtn" class="secondary-btn setup-skip">Skip Setup</button>
          <div class="setup-nav">
            <button id="setupBackBtn" class="secondary-btn" style="display:none">Back</button>
            <button id="setupNextBtn" class="primary-btn">Next</button>
          </div>
        </div>
      </div>
    </div>

    <div id="rewindModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modal-head">
          <h2 id="rewindModalTitle">Rewind Conversation</h2>
          <button id="rewindModalCloseBtn" class="icon-btn" aria-label="Close">x</button>
        </div>
        <p id="rewindModalText" class="rewind-text"></p>
        <div class="modal-actions">
          <button id="rewindCancelBtn" class="secondary-btn">Cancel</button>
          <button id="rewindConfirmBtn" class="primary-btn">Rewind</button>
        </div>
      </div>
    </div>

    <div id="connectionErrorModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="modal connection-error-modal">
        <div class="modal-head">
          <h2 id="connErrorTitle">Connection Lost</h2>
        </div>
        <p id="connErrorDesc" class="conn-error-desc">Unable to reach the agent. Retrying automatically...</p>
        <div class="conn-error-countdown">
          <div class="conn-error-spinner"></div>
          <span id="connErrorCountdown">Retrying in 5s...</span>
        </div>
        <div class="modal-actions">
          <button id="connErrorRetryBtn" class="primary-btn">Retry Now</button>
          <button id="connErrorDismissBtn" class="secondary-btn">Dismiss</button>
        </div>
      </div>
    </div>

    <div id="welcomeOverlay" class="welcome-overlay hidden">
      <div class="welcome-content">
        <img class="welcome-logo" src="./logo.png" alt="uxRoai" />
        <h2 class="welcome-title" id="welcomeOverlayTitle">Welcome to uxRoai Studio</h2>
        <p class="welcome-desc" id="welcomeOverlayDesc">Your AI-powered Roblox development companion</p>
        <button id="welcomeDismissBtn" class="welcome-dismiss-btn">Get Started</button>
      </div>
    </div>

    <script type="module" src="./renderer.js"></script>
  </body>
</html>
